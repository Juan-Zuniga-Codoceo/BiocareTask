<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BiocareTask - Tablero</title>

  <link rel="stylesheet" href="/css/tablero.css" />
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/assets/logo.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

</head>

<body>
  <div id="app">
    <div class="overlay" v-if="mostrarNotificaciones" @click="toggleNotifications"></div>
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <img src="/assets/logo.png" alt="Biocare Logo" />
          <h1><span class="biocare">Biocare</span><span class="task">Task</span></h1>
        </div>
      </div>
      <div class="header-right">
        <div class="main-controls">
          <div class="filters">
            <label for="filtro-fecha" class="filter-label">Vencimiento:</label>
            <input type="date" id="filtro-fecha" v-model="filtroFecha" />

            <label class="filter-checkbox">
              <input type="checkbox" v-model="misTareas" /> Mis Tareas
            </label>
          </div>
          <button class="btn-create" @click="showModal = true">
            <i class="fa-solid fa-plus"></i> Nueva Tarea
          </button>
        </div>
        <div class="user-actions">
          <div class="notifications">
            <button class="btn-icon" @click="toggleNotifications" title="Notificaciones">
              <i class="fa-solid fa-bell"></i>
              <span class="notification-badge" v-if="notificacionesPendientes > 0">
                {{ notificacionesPendientes }}
              </span>
            </button>
            <div class="notifications-panel" v-if="mostrarNotificaciones">
              <div class="notifications-header">
                <h3>Notificaciones</h3>
                <button class="btn-mark-all-read" @click="marcarTodasComoLeidas" v-if="notificacionesPendientes > 0">
                  Marcar todas como leídas
                </button>
                <button @click="mostrarNotificaciones = false" class="btn-close-modal">×</button>
              </div>
              <div class="notifications-list">
                <div v-for="notificacion in notificaciones" :key="notificacion.id" class="notification-item"
                  :class="{'unread': !notificacion.leida}">
                  <div class="notification-content">
                    <p>{{ notificacion.mensaje }}</p>
                    <small>{{ formatDate(notificacion.fecha_creacion) }}</small>
                  </div>
                  <div class="notification-actions">
                    <button v-if="!notificacion.leida" @click.stop="marcarComoLeida(notificacion.id)"
                      class="btn-icon-action" title="Marcar como leída">
                      <i class="fa-solid fa-check"></i>
                    </button>
                    <button @click.stop="eliminarNotificacion(notificacion.id)" class="btn-icon-action danger"
                      title="Eliminar">
                      <i class="fa-solid fa-trash-can"></i>
                    </button>
                  </div>
                </div>
                <p v-if="notificaciones.length === 0" class="empty">No hay notificaciones</p>
              </div>
            </div>
          </div>
          <div class="user-menu">
            <div class="dropdown">
              <button class="btn-icon" @click="toggleDropdown" title="Mi Perfil">
                <i class="fa-solid fa-user-gear"></i>
              </button>
              <div class="dropdown-menu" v-if="showDropdown">
                <a href="/perfil"><i class="fa-solid fa-user"></i> Mi Perfil</a>
                <a href="javascript:void(0)" @click="logout()"><i class="fa-solid fa-right-from-bracket"></i> Cerrar
                  sesión</a>
              </div>
            </div>
            <span class="user-name">{{ user.name }}</span>
          </div>
        </div>
      </div>
    </header>

    <main class="dashboard">
      <div class="summary">
        <div class="summary-card">
          <div class="card-icon total"><i class="fa-solid fa-list-check"></i></div>
          <div class="card-content">
            <span class="card-value">{{ resumen.total_pendientes }}</span>
            <span class="card-label">Pendientes</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="card-icon proximas"><i class="fa-solid fa-calendar-day"></i></div>
          <div class="card-content">
            <span class="card-value">{{ resumen.proximas }}</span>
            <span class="card-label">Próximas</span>
          </div>
        </div>
        <div class="summary-card" v-if="resumen.vencidas > 0">
          <div class="card-icon vencidas"><i class="fa-solid fa-triangle-exclamation"></i></div>
          <div class="card-content">
            <span class="card-value">{{ resumen.vencidas }}</span>
            <span class="card-label">Vencidas</span>
          </div>
        </div>
      </div>

      <div class="kanban-board">
        <div class="kanban-column column-pending">
          <h2 class="column-title">
            <i class="fa-regular fa-clock"></i> Pendientes
          </h2>
          <div class="task-list">
            <div v-for="task in tareasPendientes" :key="task.id" class="task-card"
              :class="{ 'vence-hoy': esTareaParaHoy(task.due_date) }" @click="verDetalles(task)">
              <h3>{{ task.title }}</h3>
              <p>{{ task.description }}</p>
              <div class="task-meta">
                <span class="due-date"><i class="fa-regular fa-calendar"></i> {{ formatDate(task.due_date) }}</span>
                <div class="labels">
                  <span v-for="label in getLabelsArray(task)" :key="label" class="label-tag"
                    :style="{ backgroundColor: getColor(label) }">{{ label }}</span>
                </div>
              </div>
              <div class="task-footer">
                <span class="assigned-to"><i class="fa-solid fa-user-tag"></i> {{ task.assigned_names || 'Sin asignar'
                  }}</span>
                <button @click.stop="moverACamino(task.id)" class="btn-action">En Camino <i
                    class="fa-solid fa-arrow-right"></i></button>
              </div>
            </div>
            <p class="empty" v-if="tareasPendientes.length === 0">No hay tareas pendientes</p>
          </div>
        </div>
        <div class="kanban-column column-progress">
          <h2 class="column-title">
            <i class="fa-solid fa-truck-fast"></i> En Camino
          </h2>
          <div class="task-list">
            <div v-for="task in tareasEnCamino" :key="task.id" class="task-card" @click="verDetalles(task)">
              <h3>{{ task.title }}</h3>
              <p>{{ task.description }}</p>
              <div class="task-meta">
                <span class="due-date"><i class="fa-regular fa-calendar"></i> {{ formatDate(task.due_date) }}</span>
                <div class="labels">
                  <span v-for="label in getLabelsArray(task)" :key="label" class="label-tag"
                    :style="{ backgroundColor: getColor(label) }">{{ label }}</span>
                </div>
              </div>
              <div class="task-footer">
                <span class="assigned-to"><i class="fa-solid fa-user-tag"></i> {{ task.assigned_names || 'Sin asignar'
                  }}</span>
                <button @click.stop="completar(task.id)" class="btn-action green">Completar <i
                    class="fa-solid fa-check"></i></button>
              </div>
            </div>
            <p class="empty" v-if="tareasEnCamino.length === 0">No hay tareas en camino</p>
          </div>
        </div>
        <div class="kanban-column column-done">
          <h2 class="column-title">
            <i class="fa-solid fa-flag-checkered"></i> Completadas
          </h2>
          <div class="task-list">
            <div v-for="task in tareasCompletadas" :key="task.id" class="task-card completed"
              @click="verDetalles(task)">
              <h3>{{ task.title }}</h3>
              <p>{{ task.description }}</p>
              <div class="task-meta">
                <small>Completado el {{ formatDate(task.completed_at) }}</small>
              </div>
              <div class="task-footer">
                <span class="assigned-to"><i class="fa-solid fa-user-tag"></i> {{ task.assigned_names || 'Sin asignar'
                  }}</span>
              </div>
            </div>
            <p class="empty" v-if="tareasCompletadas.length === 0">No hay tareas completadas</p>
          </div>
        </div>
      </div>
    </main>

    <div class="modal" v-if="showModal" @click.self="showModal = false">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fa-solid fa-plus"></i> Crear Nueva Tarea</h2>
          <button @click="showModal = false" class="btn-close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="title">Título *</label>
            <input id="title" type="text" v-model="newTask.title" placeholder="Ej: Preparar informe de ventas"
              required />
          </div>
          <div class="form-group">
            <label for="description">Descripción</label>
            <textarea id="description" v-model="newTask.description"
              placeholder="Añade más detalles sobre la tarea..."></textarea>

            <div v-if="suggestedLabels.length > 0" class="suggestions-container">
              <span class="suggestions-title">Sugerencias:</span>
              <span v-for="label in suggestedLabels" :key="label.id" class="pill suggestion-pill"
                @click="toggleLabelInNew(label.id)">
                + {{ label.name }}
              </span>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="new-task-datepicker">Fecha de Entrega *</label>
              <div class="date-input-wrapper">
                <input id="new-task-datepicker" type="text" v-model="newTask.due_date"
                  placeholder="Selecciona una fecha y hora...">
                <i class="fa-regular fa-calendar-alt"></i>
              </div>

              <div class="quick-dates">
                <button @click.prevent="setQuickDate(0)">Hoy</button>
                <button @click.prevent="setQuickDate(1)">Mañana</button>
                <button @click.prevent="setQuickDate('eod')">Fin del Día</button>
                <button @click.prevent="setQuickDate(7)">En 7 días</button>
              </div>
            </div>
            <div class="form-group">
              <label for="priority">Prioridad</label>
              <select id="priority" v-model="newTask.priority">
                <option value="baja">Baja</option>
                <option value="media" selected>Media</option>
                <option value="alta">Alta</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="assigned_to">Asignar a</label>
            <div class="pills-container user-pills">
              <span v-for="user in selectedUsersInNew" :key="user.id" class="pill user-pill">
                {{ user.name }}
                <button @click="removeUserFromNewTask(user.id)" class="remove-pill">&times;</button>
              </span>
              <span v-if="selectedUsersInNew.length === 0" class="empty-pills">Nadie asignado</span>
            </div>

            <select @change="addUserToNewTask($event.target.value)" class="user-select-add">
              <option value="" disabled selected>Añadir usuario...</option>
              <option v-for="user in availableUsersInNew" :key="user.id" :value="user.id">
                {{ user.name }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>Etiquetas</label>

            <div class="pills-container">
              <span v-for="label in selectedLabelsInNew" :key="label.id" class="pill"
                :style="{ backgroundColor: getColor(label.name) }">
                {{ label.name }}
                <button @click="toggleLabelInNew(label.id)" class="remove-pill">&times;</button>
              </span>
            </div>

            <div class="dropdown-container">
              <input type="text" placeholder="Añadir etiqueta..." @focus="showNewLabelDropdown = true"
                @blur="showNewLabelDropdown = false" class="label-input" />
              <div class="label-dropdown" v-if="showNewLabelDropdown">
                <div v-for="label in availableLabelsInNew" :key="label.id" @mousedown="toggleLabelInNew(label.id)">
                  {{ label.name }}
                </div>
                <div v-if="availableLabelsInNew.length === 0" class="empty-dropdown">
                  No hay más etiquetas para añadir.
                </div>
              </div>
            </div>
          </div>
          <div class="form-group create-label-group">
            <input type="text" v-model="nuevaEtiqueta" placeholder="O crea una nueva etiqueta..."
              @keyup.enter="crearEtiqueta" />
            <button @click="crearEtiqueta" class="btn-create-label">Crear</button>
          </div>
          <div class="form-group">
            <label for="fileInput">Adjuntar Archivo</label>
            <input type="file" @change="handleFileUpload" class="file-input" id="fileInput" />
          </div>
        </div>
        <div class="modal-footer">
          <button @click="showModal = false" class="btn-cancel">Cancelar</button>
          <button @click="crearTarea" class="btn-create" :disabled="creandoTarea">
            <i class="fa-solid fa-check"></i> {{ creandoTarea ? 'Creando...' : 'Crear Tarea' }}
          </button>
        </div>
      </div>
    </div>

    <div class="modal" v-if="tareaSeleccionada" @click.self="tareaSeleccionada = null">
      <div class="modal-content large" :class="{ 'vence-hoy': esTareaParaHoy(tareaSeleccionada.due_date) }">
        <div class="modal-header">
          <h2>
            <span>{{ tareaSeleccionada.title }}</span>
            <span v-if="esTareaParaHoy(tareaSeleccionada.due_date)" class="due-today-badge">
              <i class="fa-solid fa-fire"></i> VENCE HOY
            </span>
          </h2>
          <button @click="tareaSeleccionada = null" class="btn-close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="detail-grid">
            <div class="detail-col">
              <div class="detail-section">
                <h3><i class="fa-solid fa-align-left"></i> Descripción</h3>
                <p>{{ tareaSeleccionada.description || 'No se proporcionó una descripción.' }}</p>
              </div>
              <div class="detail-section">
                <h3><i class="fa-solid fa-comments"></i> Comentarios</h3>
                <div class="comments-list">
                  <div v-if="!tareaSeleccionada.comentarios || tareaSeleccionada.comentarios.length === 0"
                    class="empty-comments">
                    Aún no hay comentarios.
                  </div>
                  <div v-for="comentario in tareaSeleccionada.comentarios" :key="comentario.id" class="comment-item">
                    <div class="comment-avatar"
                      :style="comentario.autor_avatar_url ? { backgroundImage: `url(${comentario.autor_avatar_url})` } : {}">
                      <span v-if="!comentario.autor_avatar_url">{{ comentario.autor_nombre.charAt(0).toUpperCase()
                        }}</span>
                    </div>
                    <div class="comment-body">
                      <div class="comment-header">
                        <span class="comment-author">{{ comentario.autor_nombre }}</span>
                        <span class="comment-date">{{ formatDate(comentario.fecha_creacion) }}</span>
                      </div>
                      <div class="comment-content">
                        <p>{{ comentario.contenido }}</p>
                        <div v-if="comentario.attachments && comentario.attachments.length > 0"
                          class="comment-attachment-list">
                          <div v-for="att in comentario.attachments" :key="att.id" class="comment-attachment">
                            <a href="javascript:void(0)" @click.stop="downloadFile(att)">
                              <i class="fa-solid fa-paperclip"></i>
                              <span>{{ att.file_name }}</span>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="comment-form">
                  <textarea v-model="nuevoComentario" placeholder="Escribe un comentario..."></textarea>
                  <div v-if="commentAttachment" class="attachment-preview">
                    <i class="fa-solid fa-file"></i>
                    <span>{{ commentAttachment.name }}</span>
                    <button @click="removeCommentAttachment" class="btn-remove-attachment">&times;</button>
                  </div>
                  <div class="comment-form-actions">
                    <label for="comment-attachment-input" class="btn-attach" title="Adjuntar archivo">
                      <i class="fa-solid fa-paperclip"></i>
                      <input type="file" id="comment-attachment-input" @change="handleCommentAttachment"
                        style="display: none;" />
                    </label>
                    <button @click="agregarComentario"
                      :disabled="!nuevoComentario.trim() && !commentAttachment">Enviar</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="detail-col">
              <div class="detail-section">
                <h3><i class="fa-solid fa-circle-info"></i> Detalles</h3>
                <ul class="detail-list">
                  <li><strong>Asignado a:</strong> <span>{{ tareaSeleccionada.assigned_names || 'Nadie' }}</span></li>
                  <li><strong>Fecha Límite:</strong> <span>{{ formatDate(tareaSeleccionada.due_date) }}</span></li>
                  <li><strong>Prioridad:</strong> <span :class="'badge-' + tareaSeleccionada.priority">{{
                      getPriorityText(tareaSeleccionada.priority) }}</span></li>
                  <li><strong>Creado por:</strong> <span>{{ tareaSeleccionada.created_by_name }}</span></li>
                  <li v-if="getLabelsArray(tareaSeleccionada).length > 0">
                    <strong>Etiquetas:</strong>
                    <div class="labels">
                      <span v-for="label in getLabelsArray(tareaSeleccionada)" :key="label" class="label-tag"
                        :style="{ backgroundColor: getColor(label) }">{{ label }}</span>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="detail-section"
                v-if="tareaSeleccionada.attachments && tareaSeleccionada.attachments.length > 0">
                <h3><i class="fa-solid fa-paperclip"></i> Archivos Adjuntos</h3>
                <div class="attachments-list">
                  <div v-for="attachment in tareaSeleccionada.attachments" :key="attachment.id" class="attachment-item">
                    <i class="fa-solid fa-file"></i>
                    <span class="attachment-name">{{ attachment.file_name }}</span>
                    <button @click="downloadFile(attachment)" class="btn-download" title="Descargar"><i
                        class="fa-solid fa-download"></i></button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="modal-actions-left" v-if="puedeEditarTarea">
            <button @click="abrirModalEditar" class="btn-edit">
              <i class="fa-solid fa-pencil"></i> Editar
            </button>
            <button @click="abrirConfirmarEliminar" class="btn-delete" v-if="user.id === tareaSeleccionada.created_by">
              <i class="fa-solid fa-trash-can"></i> Eliminar
            </button>
          </div>

          <div class="modal-actions-right">
            <div class="split-button-group" v-if="tareaSeleccionada.status !== 'completada'">
              <button @click="avanzarEstado(tareaSeleccionada)" class="btn-primary-action">
                {{ tareaSeleccionada.status === 'pendiente' ? 'Iniciar Tarea' : 'Completar' }}
                <i
                  :class="tareaSeleccionada.status === 'pendiente' ? 'fa-solid fa-arrow-right' : 'fa-solid fa-check'"></i>
              </button>
              <button class="btn-split-trigger" @click.stop="toggleStateDropdown">
                <i class="fa-solid fa-chevron-down"></i>
              </button>
              <div class="split-dropdown-menu" v-if="showStateDropdown">
                <a href="#" @click.prevent="retrocederEstado(tareaSeleccionada)">
                  <i class="fa-solid fa-arrow-left"></i> Devolver a "{{ tareaSeleccionada.status === 'en_camino' ?
                  'Pendiente' : '' }}"
                </a>
              </div>
            </div>

            <div v-if="tareaSeleccionada.status === 'completada'">
              <button @click="retrocederEstado(tareaSeleccionada)" class="btn-secondary-action">
                <i class="fa-solid fa-undo"></i> Reabrir Tarea
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" v-if="showEditModal" @click.self="showEditModal = false">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fa-solid fa-pencil"></i> Editar Tarea</h2>
          <button @click="showEditModal = false" class="btn-close-modal">&times;</button>
        </div>
        <div class="modal-body">

          <div class="form-group">
            <label>Título *</label>
            <input type="text" v-model="editTask.title" required />
          </div>

          <div class="form-group">
            <label>Descripción</label>
            <textarea v-model="editTask.description"></textarea>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="edit-task-datepicker">Fecha de Entrega *</label>
              <div class="date-input-wrapper">
                <input id="edit-task-datepicker" type="text" v-model="editTask.due_date"
                  placeholder="Selecciona una fecha y hora...">
                <i class="fa-regular fa-calendar-alt"></i>
              </div>
              <div class="quick-dates">
                <button @click.prevent="setQuickEditDate(0)">Hoy</button>
                <button @click.prevent="setQuickEditDate(1)">Mañana</button>
                <button @click.prevent="setQuickEditDate('eod')">Fin del Día</button>
                <button @click.prevent="setQuickEditDate(7)">En 7 días</button>
              </div>
            </div>
            <div class="form-group">
              <label>Prioridad</label>
              <select v-model="editTask.priority">
                <option value="baja">Baja</option>
                <option value="media">Media</option>
                <option value="alta">Alta</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Asignar a</label>
            <div class="pills-container user-pills">
              <span v-for="user in selectedUsersInEdit" :key="user.id" class="pill user-pill">
                {{ user.name }}
                <button @click="removeUserFromEditTask(user.id)" class="remove-pill">&times;</button>
              </span>
              <span v-if="selectedUsersInEdit.length === 0" class="empty-pills">Nadie asignado</span>
            </div>

            <select @change="addUserToEditTask($event.target.value)" class="user-select-add">
              <option value="" disabled selected>Añadir usuario...</option>
              <option v-for="user in availableUsersInEdit" :key="user.id" :value="user.id">
                {{ user.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Etiquetas</label>
            <div class="pills-container">
              <span v-for="label in selectedLabelsInEdit" :key="label.id" class="pill"
                :style="{ backgroundColor: getColor(label.name) }">
                {{ label.name }}
                <button @click="toggleLabelInEdit(label.id)" class="remove-pill">&times;</button>
              </span>
            </div>
            <div class="dropdown-container">
              <input type="text" placeholder="Añadir etiqueta..." @focus="showLabelDropdown = true"
                @blur="showLabelDropdown = false" class="label-input" />
              <div class="label-dropdown" v-if="showLabelDropdown">
                <div v-for="label in availableLabelsInEdit" :key="label.id" @mousedown="toggleLabelInEdit(label.id)">
                  {{ label.name }}
                </div>
                <div v-if="availableLabelsInEdit.length === 0" class="empty-dropdown">
                  No hay más etiquetas para añadir.
                </div>
              </div>
            </div>
          </div>

          <div class="form-group create-label-group">
            <input type="text" v-model="nuevaEtiqueta" placeholder="O crea una nueva etiqueta..."
              @keyup.enter="crearEtiqueta" />
            <button @click="crearEtiqueta" class="btn-create-label">Crear</button>
          </div>

        </div>
        <div class="modal-footer">
          <button @click="showEditModal = false" class="btn-cancel">Cancelar</button>
          <button @click="guardarCambiosTarea" class="btn-create">
            <i class="fa-solid fa-save"></i> Guardar Cambios
          </button>
        </div>

      </div>
    </div>

    <div class="modal" v-if="showDeleteConfirm">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h2><i class="fa-solid fa-triangle-exclamation"></i> Confirmar Eliminación</h2>
        </div>
        <div class="modal-body" style="background-color: var(--c-panel-bg);">
          <p>¿Estás seguro de que deseas eliminar la tarea "<strong>{{ tareaSeleccionada.title }}</strong>"?</p>
          <p style="color: var(--c-danger); font-weight: 600;">Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button @click="showDeleteConfirm = false" class="btn-cancel">Cancelar</button>
          <button @click="eliminarTarea" class="btn-delete">
            <i class="fa-solid fa-trash-can"></i> Sí, eliminar
          </button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/tasks.js"></script>
</body>

</html>