<!DOCTYPE html>
<html lang="es">
<head>
    <title>Restablecer Contraseña</title>
    <link rel="stylesheet" href="/css/login.css" />
</head>
<body>
    <div id="reset-password-app">
        <div class="login-container" style="max-width: 500px;">
            <form @submit.prevent="resetPassword" class="login-form">
                <h2>Nueva Contraseña</h2>
                <p>Ingresa tu nueva contraseña.</p>
                <div class="success" v-if="message">{{ message }}</div>
                <div class="error" v-if="error">{{ error }}</div>
                <div class="input-group">
                    <label>Nueva Contraseña</label>
                    <input type="password" v-model="newPassword" placeholder="••••••••" required />
                </div>
                <div class="input-group">
                    <label>Confirmar Nueva Contraseña</label>
                    <input type="password" v-model="confirmPassword" placeholder="••••••••" required />
                </div>
                <button type="submit" :disabled="loading" class="btn-primary">
                    {{ loading ? 'Guardando...' : 'Cambiar Contraseña' }}
                </button>
            </form>
        </div>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        const { createApp, ref, onMounted } = Vue;
        createApp({
            setup() {
                const newPassword = ref('');
                const confirmPassword = ref('');
                const token = ref('');
                const loading = ref(false);
                const error = ref('');
                const message = ref('');

                onMounted(() => {
                    const params = new URLSearchParams(window.location.search);
                    token.value = params.get('token');
                    if (!token.value) {
                        error.value = "Token no encontrado. El enlace puede ser inválido.";
                    }
                });

                const resetPassword = async () => {
                    if (newPassword.value !== confirmPassword.value) {
                        return error.value = "Las contraseñas no coinciden.";
                    }
                    loading.value = true; error.value = ''; message.value = '';
                    try {
                        const res = await fetch('/api/reset-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: token.value, newPassword: newPassword.value })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error);
                        message.value = data.message + ' Serás redirigido para iniciar sesión.';
                        setTimeout(() => window.location.href = '/login.html', 3000);
                    } catch (err) {
                        error.value = err.message;
                    } finally {
                        loading.value = false;
                    }
                };
                return { newPassword, confirmPassword, loading, error, message, resetPassword };
            }
        }).mount('#reset-password-app');
    </script>
</body>
</html>