<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BiocareTask</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    .logo {
      width: 40px;
      height: 40px;
      background-image: url('logo.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border-radius: 50%;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Encabezado -->
 
    <header class="header">
      <div class="logo-container">
        <div class="logo"></div>
        <h1>BiocareTask</h1>
      </div>
      <div class="user-menu">
        <span v-if="user">👋 {{ user.name }}</span>
        <button @click="logout" v-if="user">Salir</button>
      </div>
    </header>

    <!-- Dashboard --> 
    <div class="dashboard" v-if="user">
      <!-- Filtros --> 
      <div class="filters">
        <label>
          <input type="checkbox" v-model="misTareas" /> Solo mis tareas
        </label>
        <label>
          <input type="date" v-model="filtroFecha" placeholder="Filtrar por fecha" />
        </label>
      </div>

      <!-- Resumen --> 
      <div class="resumen">
        <div class="card proximas">
          📅 <strong>{{ resumen.proximas }}</strong> próximas
        </div>
        <div class="card pendientes">
          📋 <strong>{{ resumen.total_pendientes }}</strong> pendientes
        </div>
      </div>

      <!-- Botón para nueva tarea --> 
      <button class="btn-create" @click="showModal = true">➕ Nueva Tarea</button>

      <!-- Tablero Kanban --> 
      <div class="kanban">
        <!-- Columna: Pendientes --> 
        <div class="column">
          <h2>Pendientes</h2>
          <div class="task" v-for="task in tareasPendientes" :key="task.id">
            <div class="task-header">
              <h3>{{ task.title }}</h3>
              <div class="priority-badge" :class="getPriorityClass(task.priority)">
                {{ getPriorityText(task.priority) }}
              </div>
            </div>
            <p>{{ task.description }}</p>
            <small>
              <strong>📅</strong> {{ formatDate(task.due_date) }}<br>
              <strong>👤</strong> {{ task.assigned_names }}<br>
              <span v-for="label in task.label_names?.split(', ')">
                <mark :style="'background-color: ' + getColor(label) + '; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px'">
                  {{ label }}
                </mark>
              </span>
            </small>
            <div class="task-actions">
              <button @click="moverACamino(task.id)" class="btn-small">➡️ En camino</button>
            </div>
          </div>
        </div>

        <!-- Columna: En camino --> 
        <div class="column">
          <h2>En camino</h2>
          <div class="task" v-for="task in tareasEnCamino" :key="task.id">
            <div class="task-header">
              <h3>{{ task.title }}</h3>
              <div class="priority-badge" :class="getPriorityClass(task.priority)">
                {{ getPriorityText(task.priority) }}
              </div>
            </div>
            <p>{{ task.description }}</p>
            <small>
              <strong>📅</strong> {{ formatDate(task.due_date) }}<br>
              <strong>👤</strong> {{ task.assigned_names }}
            </small>
            <div class="task-actions">
              <button @click="completar(task.id)" class="btn-small">✅ Completar</button>
            </div>
          </div>
        </div>

        <!-- Columna: Completadas --> 
        <div class="column">
          <h2>Completadas</h2>
          <div class="task completed" v-for="task in tareasCompletadas" :key="task.id">
            <div class="task-header">
              <h3>✅ {{ task.title }}</h3>
              <div class="priority-badge" :class="getPriorityClass(task.priority)">
                {{ getPriorityText(task.priority) }}
              </div>
            </div>
            <small>Completado el {{ formatDate(task.completed_at) }}</small>
          </div>
        </div>
      </div>

      <!-- Modal: Nueva Tarea --> 
      <div class="modal" v-if="showModal" @click.self="showModal = false">
        <div class="modal-content">
          <h2>Crear Nueva Tarea</h2>
          <input v-model="newTask.title" placeholder="Título" />
          <textarea v-model="newTask.description" placeholder="Descripción (opcional)"></textarea>
          <input type="datetime-local" v-model="newTask.due_date" />

          <select v-model="newTask.priority">
            <option value="baja">Prioridad: Baja</option>
            <option value="media">Prioridad: Media</option>
            <option value="alta">Prioridad: Alta</option>
          </select>

          <h3>Asignar a:</h3>
          <div class="user-select">
            <label v-for="u in users" :key="u.id">
              <input type="checkbox" :value="u.id" v-model="newTask.assigned_to" />
              {{ u.name }}
            </label>
          </div>

          <h3>Etiquetas:</h3>
          <div class="label-tabs">
            <div v-for="l in labels" :key="l.id" class="tab" @click="agregarEtiqueta(l.id)">
              {{ l.name }}
            </div>
            <div class="tab new-label">
              <input type="text" v-model="nuevaEtiqueta" placeholder="Crear nueva etiqueta" />
              <button @click="crearEtiqueta">Crear</button>
            </div>
          </div>

          <div class="modal-actions">
            <button @click="showModal = false">Cancelar</button>
            <button @click="crearTarea" class="btn-create">Crear Tarea</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Login Screen --> 
    <div class="login-screen" v-if="!user">
      <div class="card-login">
        <h2>Ingresa a BiocareTask</h2>
        <input type="email" v-model="email" placeholder="Correo" />
        <input type="password" v-model="password" placeholder="Clave" />
        <button @click="login" :disabled="loading">
          {{ loading ? 'Entrando...' : 'Entrar' }}
        </button>
        <button @click="mostrarRegistro = true">Registrar</button>
      </div>
    </div>

    <!-- Registro Screen --> 
    <div class="modal" v-if="mostrarRegistro" @click.self="mostrarRegistro = false">
      <div class="modal-content">
        <h2>Crear Cuenta</h2>
        <input v-model="registro.email" placeholder="Correo" />
        <input type="password" v-model="registro.password" placeholder="Clave" />
        <input type="text" v-model="registro.name" placeholder="Nombre" />
        <input type="text" v-model="registro.office" placeholder="Oficina" />
        <button @click="registrar">Crear Cuenta</button>
        <button @click="mostrarRegistro = false">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Vue.js desde CDN --> 
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="app.js"></script>
</body>
</html>